---
title: "【勉強メモ】Docker Oracle環境構築 + .Net接続サンプル"
emoji: "🕌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["dotnet","docker","oracle","test"]
published: false
---

## はじめに

勉強メモです。  
Oracle環境を立ち上げて、そこでOracleの勉強しようと思いました。  
環境を汚したくないので、折角なのでDockerで環境を立ち上げようと思いました。  
Docker+Oracleによる環境構築記事は沢山あるので、そちらをほぼ参考にしつつ、自分が躓いたところや立ち上げた環境に対して.Net技術でアクセスしてみるところまでをまとめます。  

ほぼ[こちらの記事(【Docker】Oracleを無料で簡単にローカルに構築する)](https://zenn.dev/re24_1986/articles/29430f2f8b4b46)を参考にしています。  
感謝。  

## 環境

- Win11  
- Docker 24.0.6, build ed223bc  
- .NET 6
- PowerShell

## Docker環境構築

Dockerの環境構築に関しては参考記事の通りに進めていけば問題ありませんが、使用するターミナルは`git bash`以外が良いです。
Windows使っている場合はPowerShell使っておけば問題ないです。  
理由は`git bash`だと`docker command`が認識できないからです。  

- リポジトリのクローン  
- ORACLE EXPRESS EDITIONのダウンロード  
- リポジトリにダウンロードしたOracleを配置  

ここまでは手順どおりで問題ありませんが、[イメージ作成シェルの実行]は参考コードでは動きません。  
カレントディレクトリのパス指定は`.\`ではなく`./`が正解です。  

``` bash
./buildContainerImage.sh -v 21.3.0 -x -i

# 元のコード
.\buildContainerImage.sh -v 21.3.0 -x -i
```

この作業で結構待ちます。

## .NETから接続してみる

- プロジェクト作成  
  - ConsoleApp  
  - .NET 6  
- NuGet インストール  
  - Dapper 2.1.24  
  - Oracle.ManagedDataAccess 21.12.0  
  - Oracle.ManagedDataAccess.Core 3.21.120  

以下コピペ  

``` c#
using Dapper;
using Oracle.ManagedDataAccess.Client;

namespace docker_oracle;

internal class Program
{
    static void Main(string[] args)
    {
        string connectionString = "User Id=sys;Password=passw0rd;Connection Timeout=0;DBA Privilege=SYSDBA;Data Source=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=localhost)(PORT=1521)))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=XEPDB1)));";

        using OracleConnection db = new(connectionString);

        // テーブルの作成
        var createTableQuery = @"
                BEGIN
                    EXECUTE IMMEDIATE 'CREATE TABLE SampleTable (
                        Id NUMBER GENERATED BY DEFAULT AS IDENTITY,
                        Name VARCHAR2(100),
                        Age NUMBER
                    )';
                EXCEPTION
                    WHEN OTHERS THEN
                        IF SQLCODE != -955 THEN
                            RAISE;
                        END IF;
                END;";

        db.Execute(createTableQuery);

        // データの挿入
        var insertQuery = "INSERT INTO SampleTable (Name, Age) VALUES (:Name, :Age)";
        db.Execute(insertQuery, new { Name = "John Doe", Age = 30 });
        db.Execute(insertQuery, new { Name = "Hoge Fuga", Age = 25 });

        // データの選択
        var selectQuery = "SELECT * FROM SampleTable";
        var data = db.Query<SampleTable>(selectQuery);

        foreach (var item in data)
        {
            Console.WriteLine($"ID: {item.Id}, Name: {item.Name}, Age: {(int)item.Age}");
        }
    }
}

public class SampleTable
{
    public int Id { get; set; }
    public string Name { get; set; }
    public int Age { get; set; }
}
```

次の構文は一番最初に試した構文ですが、接続できませんでした。  

``` cs
"User Id=sys;Password=passw0rd;Data Source=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=localhost)(PORT=1521)))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=XE)));";
```

`Connection Timeout=0;`と`DBA Privilege=SYSDBA;`を含めることで接続できますが、無理やり接続するためのオプションなので良くはないはずです。  

``` cs
"User Id=sys;Password=passw0rd;Connection Timeout=0;DBA Privilege=SYSDBA;Data Source=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=localhost)(PORT=1521)))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=XEPDB1)));";
```

接続がうまく行かない時に参考にしたサイト群  

- [Oracle Data Provider for .NET (ODP.NET) で ORA-12154 が発生した場合の対処](https://blog.officekoma.co.jp/2017/11/oracle-data-provider-for-net-odpnet-ora.html) 
- [Oracle.ManagedDataAccess: ORA-01882: timezone region not found' - Oracle Forums](https://forums.oracle.com/ords/apexds/post/oracle-manageddataaccess-ora-01882-timezone-region-not-foun-9972) 
- [UseHourOffsetForUnsupportedTimezone](https://docs.oracle.com/en/database/oracle/oracle-database/21/odpnt/ConnectionUseHourOffsetForUnsupportedTimezone.html#GUID-C66B87C3-0DBB-4609-A57A-D7F9FAD79F72)
- [Oracle.ManagedDataAccess Connection request timed out – iTecNote](https://itecnote.com/tecnote/oracle-manageddataaccess-connection-request-timed-out/)

## 参考

[【Docker】Oracleを無料で簡単にローカルに構築する](https://zenn.dev/re24_1986/articles/29430f2f8b4b46)
