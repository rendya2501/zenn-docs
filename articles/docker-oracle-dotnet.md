---
title: "【勉強メモ】DockerでOracleの環境構築 + .Net接続サンプル"
emoji: "🕌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["dotnet","csharp","docker","oracle"]
published: false
---

## はじめに

完全に個人用の勉強メモです。  

- Oracle学習のために環境を構築したい
- でもローカルの環境を汚したくない
- それならDockerだよね

ということで、こちらの記事([【Docker】Oracleを無料で簡単にローカルに構築する](https://zenn.dev/re24_1986/articles/29430f2f8b4b46))をほぼ参考にしつつ、躓いたところをまとめたり、立ち上げた環境に対してC#で簡単なCRUDプログラムを実行する所までをまとめました。  

## 実行環境

- Win11  
- Docker 24.0.6, build ed223bc  
- .NET 8  
- VSCode  

## Docker環境構築に関して

Dockerの環境構築に関しては参考記事の通りに進めていけば基本的に問題はありません。  

- リポジトリのクローン  
- ORACLE EXPRESS EDITIONのダウンロード  
- リポジトリにダウンロードしたOracleを配置  

ここまでは手順どおりで問題ありませんが、`イメージ作成シェルの実行` は参考サイトのコマンドでは動きません。  
カレントディレクトリのパス指定は`.\`ではなく`./`が正しいです。  

``` bash
./buildContainerImage.sh -v 21.3.0 -x -i

# 元のコード
.\buildContainerImage.sh -v 21.3.0 -x -i
```

後は参考サイトの通りに構築していけば良いです。  

- 生成物確認
  - docker images
- ymlファイル作成
- コンテナ作成 & 起動
  - docker-compose up -d  

## .NETから接続してみる

プロジェクト作成  

- ConsoleApp
- .NET 6  
- トップレベルステートは使用しない  

`dotnet new console -f net8.0 -n DockerOracle`

NuGet インストール

- Dapper 2.1.24
- Oracle.ManagedDataAccess.Core 3.21.120  

簡単なサンプルなので、ChatGPTに作ってもらいました。  
ただ、接続文字列はそのままでは使用できなかったため、少し修正しています。  
それについては後半で解説します。  

愚直に接続。  
テーブルが存在しなければ作成するクエリを実行。  
適当にデータを挿入。  
単純にSELECTして表示。  

``` c# : サンプルコード
using Dapper;
using Oracle.ManagedDataAccess.Client;

namespace docker_oracle;

internal class Program
{
    static void Main(string[] args)
    {
        // 接続文字列
        string connectionString = "User Id=sys;Password=passw0rd;DBA Privilege=SYSDBA;Data Source=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=localhost)(PORT=1521)))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=XEPDB1)));";

        // DB接続
        using OracleConnection db = new(connectionString);

        // テーブルの作成クエリ実行
        var createTableQuery = @"
                BEGIN
                    EXECUTE IMMEDIATE 'CREATE TABLE SampleTable (
                        Id NUMBER GENERATED BY DEFAULT AS IDENTITY,
                        Name VARCHAR2(100),
                        Age NUMBER
                    )';
                EXCEPTION
                    WHEN OTHERS THEN
                        IF SQLCODE != -955 THEN
                            RAISE;
                        END IF;
                END;";
        db.Execute(createTableQuery);

        // データの挿入
        var insertQuery = "INSERT INTO SampleTable (Name, Age) VALUES (:Name, :Age)";
        db.Execute(insertQuery, new { Name = "John Doe", Age = 30 });
        db.Execute(insertQuery, new { Name = "Hoge Fuga", Age = 25 });

        // データの選択
        var selectQuery = "SELECT * FROM SampleTable";
        var data = db.Query<SampleTable>(selectQuery);

        // データの表示
        foreach (var item in data)
        {
            Console.WriteLine($"ID: {item.Id}, Name: {item.Name}, Age: {(int)item.Age}");
        }
    }
}

public class SampleTable
{
    public int Id { get; set; }
    public string Name { get; set; }
    public int Age { get; set; }
}
```

次の接続文字列はChatGPT3時代に生成してもらった物ですが、これでは接続できませんでした。  

``` cs
string connectionString = "User Id=sys;Password=passw0rd;DBA Privilege=SYSDBA;Data Source=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=localhost)(PORT=1521)))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=XEPDB1)));";
```

エラーメッセージは次の通りです。

``` logs
Unhandled exception. Oracle.ManagedDataAccess.Client.OracleException (0x80004005): ORA-28009: connection as SYS should be as SYSDBA or SYSOPER
```

見た感じ権限のエラーっぽいです。  
どうやらユーザーに `User Id=sys;` を指定すると自動的に、`SYSユーザー` としてログインすることとなり、その場合、接続文字列に`DBA Privilege=SYSDBA;`を含めなければならないようです。  

`SYSユーザー` はデータベース管理者用の特権ユーザーであり、通常のアプリケーションで使用するのは推奨されないようです。  

本来であれば、事前にユーザーを作成して、そのユーザーでログインすべきですが、今回は簡単なサンプルなのでご容赦ください。  

## 参考サイト

[【Docker】Oracleを無料で簡単にローカルに構築する](https://zenn.dev/re24_1986/articles/29430f2f8b4b46)
